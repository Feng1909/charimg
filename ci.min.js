/*! ci v1.2 | 字符画生成 | ctchen */
!function(a,b){var c=function(){function f(){if(e&&e.url!=d.workerJs&&(e=null),!e&&d.workerJs&&"undefined"!=typeof Worker)try{e=new Worker(d.workerJs),e.addEventListener("message",function(a){e.handle&&e.handle(null,a.data)},!1),e.addEventListener("error",function(a){e.handle&&e.handle(a),d.onerror&&d.onerror(a),e=d.workerJs=null},!1),e.on=function(a){e.handle=a},e.url=d.workerJs}catch(a){d.onerror&&d.onerror(a),e=d.workerJs=null}return e}function h(a,b,c){if(f(),d.workerJs&&e)try{e.on(function(e,f){if(e)d.onerror&&d.onerror(e),g[a].call(null,b,c);else{if(f)for(var h in f)f[h]&&b[h]&&f[h]instanceof Array&&(b[h].length=0,f[h]=$.extend(b[h],f[h]));c(f)}}),e.postMessage({algName:a,opts:b})}catch(h){d.onerror&&d.onerror(h)}else g[a].call(null,b,c)}function i(a,b,c){function f(){if(d++,d<b.length){var g=b[d];"function"==typeof g?g.call({index:d+1,count:b.length},e,function(b,d){b?c&&c(b,e):(e=d,a?setTimeout(f,0):f())}):f()}else c&&c(null,e)}("function"==typeof a||a instanceof Array)&&(c=b,b=a,a=!1),"function"==typeof b?b=[b]:b||(b=[]),"function"!=typeof c&&(c=null);var e,d=-1;f()}function j(a){return a&&/^img|canvas$/i.test(a.tagName)}var e,d={async:!1,workerJs:null,random:!1,orientation:!1,minWidth:150,minHeight:150,fontFamily:["黑体"],minFontSize:12,fontZoom:10,fontColor:"#000000",square:!1,useOnes:!1,backgroundColor:"#ffffff",shadowColor:"#000000",onerror:null},g={mosaic:function(a,b){var o,p,q,r,s,t,x,u,v,w,y,z,A,B,C,c=a.imageData,d=c.data,e=a.indexTable,f=a.width,g=4*f,h=a.height||parseInt(d.length/g),i=parseInt(a.size)||7,j=i*i,k=i*g,l=4*i,m="threshold"in a,n=a.threshold>0?255*a.threshold:127.5;for(o=0,p=0,q=0;h>o;o+=i,p+=k,q++)for(r=0,s=p,t=0;f>r;r+=i,s+=l,t++){for(u=[0,0,0],v=f-r,w=h-o,i>v||i>w?(i>v||(v=i),i>w||(w=i),x=v*w):(v=i,w=i,x=j),y=0,z=s;w>y;y++,z+=g)for(A=0,B=z;v>A;A++,B+=4)0==d[B+3]?(u[0]+=255,u[1]+=255,u[2]+=255):(u[0]+=d[B],u[1]+=d[B+1],u[2]+=d[B+2]);if(m?(u[0]=(.299*u[0]+.587*u[1]+.114*u[2])/x,u[0]=u[1]=u[2]=u[0]>n?255:0):(u[0]=parseInt(u[0]/x),u[1]=parseInt(u[1]/x),u[2]=parseInt(u[2]/x)),e&&(e[q]||(e[q]=[]),e[q][t]=u),!a.notWrite)for(y=0,z=s;w>y;y++,z+=g)for(A=0,B=z;v>A;A++,B+=4)d[B]=u[0],d[B+1]=u[1],d[B+2]=u[2]}return C={imageData:c,indexTable:e},b&&b(C),C},layout:function(a,b){function l(a,b,c){var g,h,d=[],e=c?2:4,f=c?3:5;for(g=0;g<a.length;g++)h=a[g],h.forEach(function(a){b[Math.ceil(a[f])]>=a[e]&&(a[8]=g,d.push(a))});return d}var m,n,o,p,q,r,s,v,t,u,w,x,y,c=a.renderTable,e=a.indexTable,f=a.wordList,g=a.maxWidth,h=a.maxHeight,i=a.fontSize,j=a.vertical,k=a.useOnes;for(m=0;m<e.length&&f.length;m++)for(n=0;n<e[m].length&&f.length;n++)if(e[m][n]&&0==e[m][n][0]){for(o={},p=0,q=Math.min(e.length-m,h);q>p;p++){for(r=0,s=Math.min(g,e[p].length-n,o[p]?o[p]:e[p].length);s>r&&e[m+p][n+r]&&0==e[m+p][n+r][0];r++)o[p+1]=r+1;if(!o[p+1])break}if(t=0==j||Math.random()>=j,u=l(f,o,t),t||u&&u.length||(t=!t,u=l(f,o,t)),u.length&&(v=u.length*Math.random(),d.random||(v*=Math.random()),u=u[parseInt(v)])){if(w=n*i,x=m*i,null!=u[7]?c.push([null,w,x,u[2],u[3],u[7]]):((u[6]>0||u[6]<0)&&(x-=u[6]),c.push([u[0],w,x,u[1],t?0:u[3]*i])),k&&(f.splice(u[8],1),!f.length))break;for(q=t?u[3]:u[5],s=t?u[2]:u[4],p=0;q>p;p++)for(r=0;s>r;r++)e[m+p]&&(e[m+p][n+r]=null);n+=parseInt(s-1)}}else e[m][n]=null;return y={renderTable:c},b&&b(y),y}};return"undefined"==typeof a&&(this.window=this.document={},this.onmessage=function(a){a.data.algName&&g[a.data.algName]?g[a.data.algName].call(null,a.data.opts,function(a){postMessage(a)}):postMessage(a.data.opts)}),a.URL||(a.URL=a.webkitURL),{setting:d,covenToArray:function(a){return a instanceof Array?a:[a]},getFileUrl:function(b,c,d){var e,f;"function"==typeof c&&(d=c,c=null);try{!/FileReader/.test(c)&&a.URL?(e=a.URL.createObjectURL(b),d&&d(null,e)):(f=new FileReader,f.onload=function(){d&&d(null,this.result)},f.onerror=function(){d&&d("FileReader解析失败")},f.readAsDataURL(b))}catch(g){d&&d(g)}},openImgUrl:function(a,b){if(a){var c=new Image;c.onload=function(){b&&b(null,c)},c.onerror=function(){b&&b("error")},c.src=a}},parseImgOrientation:function(a,b){function d(b,d,e){c.onload=function(){var c,d;if(this.result&&this.result.byteLength>0)try{d=new Uint8Array(this.result,b,this.result.byteLength)}catch(f){c=f}else c="File End";e&&e(c,b,d)};try{var f=a;a.slice&&(f=a.slice(b,d),b=0),c.readAsArrayBuffer(f)}catch(g){e&&e(g)}}function e(a,b,c,d){var f,e=0;for(c=c>0?c:0,d=d>0?d:b.length-c,f=0;d>f;f++)e<<=8,e+=b[a?c+f:c+d-f-1];return e}function f(a,b,c){255==b[0]&&225==b[1]?69==b[4]&&120==b[5]&&105==b[6]&&102==b[7]?c&&c(null,a+10,Array.prototype.slice.call(b,10)):c&&c("Not Exif"):(a+=e(!0,b,2,2)+2,d(a,8e3,function(a,b,d){a?c&&c(a):f(b,d,c)}))}var c=new FileReader;d(0,8e3,function(a,c,d){d&&255==d[0]&&216==d[1]?(c+=2,f(c,Array.prototype.slice.call(d,2),function(a,c,d){var f,g,h,i,j,k;if(a)return b&&b("No Exif");if(73==d[0]&&73==d[1])f=0;else{if(77!=d[0]||77!=d[1])return b&&b("Unknown Endian");f=1}for(g=e(f,d,4,4),h=e(f,d,g,2),g+=2,i=0;h>i;i++){if(j=e(f,d,g,2),274==j)return k=e(f,d,g+8,2),b&&b(null,k);g+=12}b&&b(null,0)})):b&&b("Not jpeg")})},openImgFile:function(a,b,c){"function"==typeof b&&(c=b,b=null),b||(b={});var f,e=this,g=null==b.orientation?d.orientation:b.orientation;!a||!/image/.test(a.type)&&a.type?a&&c&&c("请选择图片文件"):this.getFileUrl(a,f,function(f,h){f?c&&c(f):e.openImgUrl(h,function(f,h){f?c&&c(f):g?e.parseImgOrientation(a,function(a,b){var f,g,i,j;if(a)d.onerror&&d.onerror(a),f=e.loadImgToCanvas(h).canvas;else{switch(g=h.width,i=h.height,b>=5&&8>=b&&(g=h.height,i=h.width),f=e.createCanvas(g,i),j=f.getContext("2d"),b){case 2:j.translate(g,0),j.scale(-1,1);break;case 3:j.translate(g,i),j.rotate(Math.PI);break;case 4:j.translate(0,i),j.scale(1,-1);break;case 5:j.rotate(.5*Math.PI),j.scale(1,-1);break;case 6:j.rotate(.5*Math.PI),j.translate(0,-h.height);break;case 7:j.rotate(.5*Math.PI),j.translate(g,-h.height),j.scale(-1,1);break;case 8:j.rotate(-.5*Math.PI),j.translate(-h.width,0)}j.drawImage(h,0,0,h.width,h.height)}c&&c(null,f)}):c&&c(null,"canvas"==b.type?e.loadImgToCanvas(h).canvas:h)})})},loadImgToCanvas:function(a,b){var c,e,f,g,h,i,j,k;return b||(b={}),c=b.width||a.width,e=b.height||a.height,c<d.minWidth&&(e=parseInt(d.minWidth*e/c),c=d.minWidth),e<d.minHeight&&(c=parseInt(d.minHeight*c/e),e=d.minHeight),f=b.canvas?b.canvas:this.createCanvas(c,e,b.viewWidth,b.viewHeight),g=f.getContext("2d"),h=0,i=0,j=c,k=e,(j!=a.width||k!=a.height)&&(j=c/a.width,k=e/a.height,j>k?(j=k*a.width,k=e,h=(c-j)/2):(k=j*a.height,j=c,i=(e-k)/2)),b.backgroundColor&&(g.fillStyle=b.backgroundColor,g.fillRect(0,0,c,e)),g.drawImage(a,h,i,j,k),{canvas:f,width:c,height:e,originalWidth:a.width,originalHeight:a.height}},createCanvas:function(a,c,d,e,f){var g,h,i;return"object"==typeof a&&a&&a.width&&(g=a.backgroundColor,f=a.name,d=a.viewWidth,e=a.viewHeight,c=a.height,a=a.width),h=b.createElement("canvas"),a>0&&(h.width=a,c>0||(c=a)),c>0&&(h.height=c),d&&(h.style.width=d+(d>0?"px":"")),e&&(h.style.height=e+(e>0?"px":"")),f&&h.setAttribute("data-name",f),g&&(i=h.getContext("2d"),i.fillStyle=g,i.fillRect(0,0,h.width,h.height)),h},createBgCanvas:function(a,b,c,d){"object"==typeof a&&a&&a.width&&(c=a.viewWidth,d=a.viewHeight,b=a.height,a=a.width);var e=this.createCanvas(a,b,c,d),f=this.createCanvas(40,40),g=f.getContext("2d");return g.fillStyle="#fff",g.fillRect(0,0,40,40),g.fillStyle="rgba(220,220,220,.5)",g.fillRect(20,0,20,20),g.fillRect(0,20,20,20),g=e.getContext("2d"),g.fillStyle=g.createPattern(f,"repeat"),g.fillRect(0,0,a,b),e},woodcut:function(a,b){var c,d,e,f,g,h,i,j,k,l,m,n,o,p;for(b=$.extend({},b),c=a.getContext("2d"),d=c.getImageData(0,0,a.width,a.height),e=d.data,f=b.pR||0,g=b.pG||0,h=b.pB||0,i=null!=b.pA?b.pA:255,j=null!=b.bR?b.bR:255,k=null!=b.bG?b.bG:255,l=null!=b.bB?b.bB:255,m=null!=b.bA?b.bA:255,n=b.threshold>0?765*b.threshold:382.5,o=0,p=e.length;p>o;o+=4)0==e[o+3]||e[o]+e[o+1]+e[o+2]>n?(e[o]=j,e[o+1]=k,e[o+2]=l,e[o+3]=m):(e[o]=f,e[o+1]=g,e[o+2]=h,e[o+3]=i);b.target&&(c=b.target.getContext("2d")),c.putImageData(d,0,0)},mosaic:function(a,b,c){b=$.extend({},b);var d=a.getContext("2d");h("mosaic",{imageData:d.getImageData(0,0,a.width,a.height),width:a.width,height:a.height,size:b.size,threshold:b.threshold,indexTable:b.indexTable,notWrite:b.notWrite},function(a){b.notWrite||(b.target&&(d=b.target.getContext("2d")),d.putImageData(a.imageData,0,0)),c&&c(a)})},getFontDeviation:function(a,b){var g,h,i,j,k,d=c.createCanvas(),e=d.getContext("2d"),f=12;for(d.width=f,d.height=3*f,e.textBaseline=b||"top",e.font=f+"px "+a,e.fillStyle="#fff",e.fillText("─",0,f),g=e.getImageData(parseInt(d.width/2),0,1,d.height),h=g.data,i=0,j=0,k=h.length;k>j;j+=4)if(i++,h[j]>128)return(i-1.5*f)/f;return 0},measureText:function(a,b,c,e,f,g){var k,l,m,h=this,i=[];return a=[].concat(this.covenToArray(a)),b=this.covenToArray(b),c=c>d.minFontSize?c:d.minFontSize,e=e>=1?e:1,f||(f=[]),k={},b.forEach(function(a){k[a]=h.getFontDeviation(a,"top")}),l=this.createCanvas(),m=l.getContext("2d"),a.forEach(function(a){var h,l,n,d=[];if(i.push(d),j(a))for(h=f.length,l=1,f.push(a),g||(l=a.height/a.width),n=e;n>0;n--)d.push([null,null,n,l*n,n,l*n,null,h]);else(a=(""+a).trim())&&b.forEach(function(b){var g,h,i,j,l,f=[];for(g=1;e>=g;g++)f[g]=c*g+"px / "+c*g+"px "+b;for(m.font=c+"px / "+c+"px "+b,h=0,i=0,j=a.length,g=0;j>g;g++)l=m.measureText(a.charAt(g)).width,h+=l,l>i&&(i=l);for(h/=c,i/=c,g=e;g>0;g--)d.push([a,f[g],h*g,g,i*g,j*g,k[b]?parseInt(k[b]*c*g):0])})}),i},createCharImg:function(a,b){var f,g,e=this;return b=$.extend({},b),f="function"==typeof b.onprogress?b.onprogress:null,onended="function"==typeof b.onended?b.onended:null,wordList=b.wordList,indexTable=b.indexTable&&b.indexTable instanceof Array?b.indexTable:[],renderTable=b.renderTable&&b.renderTable instanceof Array?b.renderTable:[],fontFamily=b.fontFamily||d.fontFamily,fontSize=b.fontSize>d.minFontSize?b.fontSize:d.minFontSize,fontZoom=b.fontZoom>=1?b.fontZoom:d.fontZoom,fontColor=b.fontColor||d.fontColor,backgroundColor=b.backgroundColor||d.backgroundColor,shadowColor=b.shadowColor||d.shadowColor,square=null!=b.square?b.square:d.square,useOnes=null!=b.useOnes?b.useOnes:d.useOnes,vertical=b.vertical>0?Math.min(1,b.vertical):0,threshold=b.threshold>=0?b.threshold:.5,g=a.getContext("2d"),i(d.async,[function(a,c){var e,d=b.img;d&&"IMG"==d.tagName&&(e=this.loadImgToCanvas(d,{width:d.width,height:d.height}),b.img=e.canvas),c()},function(a,c){var d=this;0==renderTable.length&&0==indexTable.length?e.mosaic(b.img,{threshold:threshold,size:fontSize,indexTable:indexTable,notWrite:1},function(){f&&f.call(d),c()}):c()},function(a,b){var d,g,c=this;if(0==renderTable.length){for(a={maxWidth:0,maxHeight:0,imglist:[]},wordList=e.measureText(wordList,fontFamily,fontSize,fontZoom,a.imglist,square),d=0;d<wordList.length;d++)g=wordList[d],g.forEach(function(b){b[2]>a.maxWidth&&(a.maxWidth=b[2]),b[5]>a.maxHeight&&(a.maxHeight=b[5])});f&&f.call(c),b(null,a)}else b()},function(a,b){var e,c=this;0==renderTable.length?(this.index,e=a.imglist,h("layout",{indexTable:$.extend(!0,[],indexTable),renderTable:renderTable,wordList:wordList,maxWidth:a.maxWidth,maxHeight:a.maxHeight,fontSize:fontSize,vertical:vertical,useOnes:useOnes},function(){renderTable.forEach(function(a){null!=a[5]&&(a[0]=e[a[5]],a[3]=Math.round(a[3]*fontSize),a[4]=Math.round(a[4]*fontSize))}),f&&f.call(c),b()})):b()},function(c,d){var e=this;g.fillStyle=backgroundColor,g.fillRect(0,0,a.width,a.height),b.backgroundImg&&/^(img|canvas)$/i.test(b.backgroundImg.tagName)&&(g.globalAlpha=b.backgroundImgOpacity>=0?b.backgroundImgOpacity:1,g.drawImage(b.backgroundImg,0,0,a.width,a.height),g.globalAlpha=1),f&&f.call(e),d()},function(c,d){var j,i,k,l,m,h=this;b.shadowOpacity>0&&(i=e.createCanvas(a.width,a.height),k=0,l=0,m=0,(j=(""+shadowColor).match(/^#([0-9a-f]{2})([0-9a-f]{2})([0-9a-f]{2})/i))&&(k=parseInt(j[1],16),l=parseInt(j[2],16),m=parseInt(j[3],16)),e.woodcut(b.img,{target:i,pR:k,pG:l,pB:m,pA:0|255*b.shadowOpacity,bA:0}),g.globalAlpha=b.shadowOpacity,g.drawImage(i,0,0,a.width,a.height),g.globalAlpha=1,f&&f.call(h)),d()},function(a,b){var c=this;g.fillStyle=fontColor,g.textBaseline="top",renderTable.forEach(function(a){var b,c,d;if(null!=a[5])a[0]&&g.drawImage(a[0],0,0,a[0].width,a[0].height,a[1],a[2],a[3],a[4]);else if(g.font=a[3],a[4]>0)for(b=a[2],c=0,d=a[0].length;d>c;c++)g.fillText(a[0].charAt(c),a[1],b),b+=a[4];else g.fillText(a[0],a[1],a[2])}),f&&f.call(c),b()},function(c,d){var e=this;b.watermarkImg&&/^(img|canvas)$/i.test(b.watermarkImg.tagName)&&(g.globalAlpha=b.watermarkImgOpacity>=0?b.watermarkImgOpacity:1,g.drawImage(b.watermarkImg,0,0,a.width,a.height),g.globalAlpha=1),f&&f.call(e),d()}],function(){onended&&onended()},!0),e}}}()}(window,document);